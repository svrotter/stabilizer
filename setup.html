<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Setup - Stabilizer</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="overview.html"><strong aria-hidden="true">1.</strong> Overview</a></li><li class="chapter-item expanded "><a href="setup.html" class="active"><strong aria-hidden="true">2.</strong> Setup</a></li><li class="chapter-item expanded "><a href="usage.html"><strong aria-hidden="true">3.</strong> Usage</a></li><li class="chapter-item expanded "><a href="firmware/dual_iir/index.html"><strong aria-hidden="true">4.</strong> Application: Dual-IIR</a></li><li class="chapter-item expanded "><a href="firmware/lockin/index.html"><strong aria-hidden="true">5.</strong> Application: Lockin</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Stabilizer</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        <a href="https://github.com/quartiq/stabilizer" title="Git repository" aria-label="Git repository">
                            <i id="git-repository-button" class="fa fa-github"></i>
                        </a>
                                                
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h3 id="table-of-contents"><a class="header" href="#table-of-contents">Table of Contents</a></h3>
<ul>
<li><a href="#setup">Setup</a>
<ul>
<li><a href="#power">Power</a></li>
<li><a href="#network-and-dhcp">Network and DHCP</a></li>
<li><a href="#mqtt-broker">MQTT Broker</a></li>
<li><a href="#building">Building</a></li>
<li><a href="#flashing">Flashing</a>
<ul>
<li><a href="#st-link-virtual-mass-storage">ST-Link virtual mass storage</a></li>
<li><a href="#dfu-upload">DFU Upload</a></li>
<li><a href="#swdjtag-firmware-development">SWD/JTAG Firmware Development</a></li>
</ul>
</li>
<li><a href="#verify-mqtt-connection">Verify MQTT connection</a></li>
</ul>
</li>
</ul>
<h1 id="setup"><a class="header" href="#setup">Setup</a></h1>
<p>The Stabilizer firmware consists of different applications tailored to different use cases.
Only one application can run on the device at a given time.
After receiving the Stabilizer hardware, you will need to choose, build, and flash one
of the applications onto the device.</p>
<h2 id="power"><a class="header" href="#power">Power</a></h2>
<p>Power Stabilizer through <strong>exactly one</strong> of the following mechanisms.</p>
<ol>
<li>Via the backside 12V barrel connector</li>
<li>Via Power-over-Ethernet using a PoE capable switch (802.3af or preferrably
802.3at) and the RJ45 front panel port</li>
<li>Via an EEM connection to Kasli</li>
</ol>
<blockquote>
<p><strong>Note:</strong> Applying power through more than one mechanism may lead to damage.
Ensure the two unused methods are not connected or explicitly disabled.</p>
</blockquote>
<h2 id="network-and-dhcp"><a class="header" href="#network-and-dhcp">Network and DHCP</a></h2>
<p>Stabilizer supports 10Base-T or 100Base-T with Auto MDI-X.
Stabilizer uses DHCP to obtain its network configuration information. Ensure there is a
properly configured DHCP server running on the network segment that Stabilizer is
connected to.
Alternatively, a static IP can be enforced in the firmware build command by specifying
the environmental variable <code>STATIC_IP</code> analogous to how a specific broker IP is set.</p>
<blockquote>
<p><strong>Note:</strong> If Stabilizer is connected directly to an Ubuntu system (for example using a USB-Ethernet dongle) 
you can set the IPv4 settings of this Ethernet connection in the Ubuntu network settings to
&quot;Shared to other computers&quot;. This will start and configure a DHCP server for this connection.</p>
</blockquote>
<h2 id="mqtt-broker"><a class="header" href="#mqtt-broker">MQTT Broker</a></h2>
<p>Stabilizer requires an MQTT broker that supports MQTTv5.
The MQTT broker is used to distribute and exchange elemetry data and to view/change application settings.
The broker must be reachable by both the host-side applications used to
interact with the application on Stabilizer and by the application running on Stabilizer.
Determine the IPv4 address of the broker as seen from the network Stabilizer is
connected to. The broker IP address must be stable. It will be used later
during firmware build.
The broker must be reachable on port 1883 on that IP address.
Firewalls between Stabilizer and the broker may need to be configured to
allow connections from Stabilizer to that port and IP address.</p>
<p><a href="https://mosquitto.org/">Mosquitto</a> has been used as a MQTT broker during development,
but any MQTTv5 broker without  authentication or encryption will likely work.</p>
<blockquote>
<p><strong>Note:</strong> Mosquitto version 1 only supports MQTTv3.1. If using Mosquitto, ensure version 2.0.0 or
later is used.</p>
</blockquote>
<p>We recommend running Mosquitto through <a href="https://docker.com">Docker</a> to easily run it on
Windows, Linux, and OSX. After docker has been installed, run the following command from
the <code>stabilizer</code> repository to create a container named <code>mosquitto</code> that can be stopped
and started easily via docker:</p>
<pre><code class="language-bash"># Bash
docker run -p 1883:1883 --name mosquitto -v `pwd`/mosquitto.conf:/mosquitto/config/mosquitto.conf -v /mosquitto/data -v /mosquitto/log eclipse-mosquitto:2

# Powershell
docker run -p 1883:1883 --name mosquitto -v ${pwd}/mosquitto.conf:/mosquitto/config/mosquitto.conf -v /mosquitto/data -v /mosquitto/log eclipse-mosquitto:2
</code></pre>
<h2 id="building"><a class="header" href="#building">Building</a></h2>
<ol>
<li>Get and install <a href="https://rustup.rs/">rustup</a> and use it to install a current stable Rust toolchain.
The minimum supported Rust version (MSRV) is 1.57.0 (2021 edition).</li>
<li>Install target support
<pre><code class="language-bash">rustup target add thumbv7em-none-eabihf
</code></pre>
</li>
<li>Install <a href="https://github.com/rust-embedded/cargo-binutils/">cargo-binutils</a>
<pre><code class="language-bash">cargo install cargo-binutils
rustup component add llvm-tools-preview
</code></pre>
</li>
<li>Clone or download the firmware
<pre><code class="language-bash">git clone https://github.com/quartiq/stabilizer
cd stabilizer
</code></pre>
</li>
<li>Build firmware specifying the MQTT broker IP. Replace <code>10.34.16.10</code> by the
stable and reachable broker IPv4 address determined above.
<pre><code class="language-bash"># Bash
BROKER=&quot;10.34.16.10&quot; cargo build --release

# Powershell
# Note: This sets the broker for all future builds as well.
$env:BROKER='10.34.16.10'; cargo build --release
</code></pre>
</li>
<li>Extract the application binary (substitute <code>dual-iir</code> below with the desired application name)
<pre><code class="language-bash"># Bash
BROKER=&quot;10.34.16.10&quot; cargo objcopy --release --bin dual-iir -- -O binary dual-iir.bin

# Powershell
$env:BROKER='10.34.16.10'; cargo objcopy --release --bin dual-iir -- -O binary dual-iir.bin
</code></pre>
</li>
</ol>
<h2 id="flashing"><a class="header" href="#flashing">Flashing</a></h2>
<p>Firmware can be loaded onto stabilizer using <strong>one</strong> of the three following methods.</p>
<blockquote>
<p><strong>Note:</strong> All methods require access to the circuit board. Pulling the device from a
crate always requires power removal as there are sensitive leads and components on
both sides of the board that may come into contact with adjacent front panels.
Every access to the board also requires proper ESD precautions. Never
hot-plug the device or the probe.</p>
</blockquote>
<h3 id="st-link-virtual-mass-storage"><a class="header" href="#st-link-virtual-mass-storage">ST-Link virtual mass storage</a></h3>
<p>If a ST-Link V2-1 or later is available this method can be used.</p>
<p>Power down the device, remove it from the crate, and connect the
SWD/JTAG probe as shown below to the device and to your computer.</p>
<p><img src="assets/stabilizer-jtag.jpg" alt="JTAG Connection" /></p>
<p>Power up the device and copy <code>dual-iir.bin</code> onto the virtual mass storage ST-Link drive
that has appeared on your computer.
Power down the device before removing the probe, inserting it into the crate
and applying power again.</p>
<h3 id="dfu-upload"><a class="header" href="#dfu-upload">DFU Upload</a></h3>
<p>If an SWD/JTAG probe is not available,
you can flash firmware using only a micro USB cable
plugged in to the front of Stabilizer, a DFU utility, and a jumper to activate
the bootloader.</p>
<ol>
<li>Install the DFU USB tool <a href="http://dfu-util.sourceforge.net"><code>dfu-util</code></a></li>
<li>Remove power</li>
<li>Then carefully remove the module from the crate to gain
access to the board</li>
<li>Short JC2/BOOT with the jumper</li>
<li>Connect your computer to the Micro USB connector below/left of the RJ45
connector on the front panel</li>
<li>Insert the module into the crate</li>
<li>Then power it</li>
<li>Perform the Device Firmware Upgrade (DFU)
<pre><code class="language-bash">dfu-util -a 0 -s 0x08000000:leave -D dual-iir.bin
</code></pre>
</li>
<li>To keep the device from entering the bootloader remove power,
pull the board from the crate, remove the JC2/BOOT jumper, insert the module
into the crate, and power it again</li>
</ol>
<h3 id="swdjtag-firmware-development"><a class="header" href="#swdjtag-firmware-development">SWD/JTAG Firmware Development</a></h3>
<p>To observe logging messages or to develop and debug applications a SWD/JTAG
probe is required. To use a compatible probe with <code>probe-run</code> connect it as
described <a href="#st-link-virtual-mass-storage">above</a>.</p>
<ol>
<li>Install <code>probe-run</code>
<pre><code class="language-bash">cargo install probe-run
</code></pre>
</li>
<li>Build and run firmware on the device
<pre><code class="language-bash"># Bash
BROKER=&quot;10.34.16.10&quot; cargo run --release --bin dual-iir

# Powershell
$Env:BROKER='10.34.16.10'; cargo run --release --bin dual-iir
</code></pre>
</li>
</ol>
<p>When using debug (non <code>--release</code>) mode, decrease the sampling frequency significantly.
The added error checking code and missing optimizations may lead to the application
missing timer deadlines and panicing.</p>
<h2 id="verify-mqtt-connection"><a class="header" href="#verify-mqtt-connection">Verify MQTT connection</a></h2>
<p>Once your MQTT broker and Stabilizer are both running, verify that the application
connects to the broker.</p>
<p>A Stabilizer application on a device is reporting its status on the following topic</p>
<pre><code>dt/sinara/dual-iir/+/alive
</code></pre>
<p>The <code>+</code> is a wildcard matching the unique MAC address of the device (e.g. <code>aa-bb-cc-00-11-22</code>).</p>
<p>Download <a href="http://mqtt-explorer.com/">MQTT-Explorer</a> to observe which topics have been posted to the
Broker.</p>
<p><img src="assets/mqtt-explorer.png" alt="MQTT Explorer Configuration" /></p>
<blockquote>
<p><strong>Note:</strong> In MQTT explorer, use the same broker address that you used when building the firmware.</p>
</blockquote>
<p>In addition to the <code>alive</code> status, telemetry messages are published at regular intervals
when Stabilizer has connected to the broker. Once you observe incoming telemetry,
Stabilizer is operational.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="overview.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="usage.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="overview.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="usage.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
